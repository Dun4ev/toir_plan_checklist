# toir_plan_checklist
# Автогенерация листов комментариев к отчётам (`*_CMM.xlsx`)

## TL;DR
Скрипт на Python автоматически создаёт рядом с каждым отчётом (`.docx` или `.pdf`) одноимённый файл `*_CMM.xlsx` из шаблона. Скрипт извлекает из имени отчёта код раздела (напр., `I.7.4`), находит по этому коду описание в файле-справочнике `TZ.xlsx` и вставляет его в созданный файл вместе с именем отчёта и датой.

---

## Цель и контекст
- **Контекст**: отчёты имеют строгие имена, например:  
  `CT-DR-B-CS-ES-II.2.6-00-C-20250812-01.docx`
- **Цель**: для каждого отчёта сформировать «лист комментариев» из шаблона, без ручного копирования, подставляя в него актуальное описание работ из централизованного справочника.

---

## Входы и выходы
**Вход**
- Папка с отчётами `*.docx` и/или `*.pdf` (имена начинаются с `CT-DR-`). Скрипт ищет файлы в выбранной папке и во всех её подпапках.
- Шаблон Excel: `Template/CommentSheet_Template.xltx`.
- Файл-справочник: `Template/TZ.xlsx` с кодами работ в колонке B и их описанием в колонке C.

**Выход**
- Для каждого отчёта создаётся соседний файл `*_CMM.xlsx` с заполненными полями.
  - Пример: `CT-DR-B-CS-ES-II.2.6-00-C-20250812-01_CMM.xlsx`

---

## Логика работы и парсинг
- **Входной файл**: `*.docx` или `*.pdf`, имя начинается с `CT-DR-`.
- **Выходной файл**: `<ИмяОтчётаБезРасширения>_CMM.xlsx` рядом с исходным файлом.
- **Извлечение данных** (для заполнения поля `ExtraField1` в ячейке D6):
  - Из имени входного файла извлекается **код пункта** по регулярному выражению `\b((?:[IVXLCDM]+)\.(?:\d+)(?:\.\d+)?(?:\.\d+)?(?:[A-Za-zА-Яа-я])?)\b` (например, `II.12`, `II.2.6` или `I.12.7a`).
  - Скрипт открывает файл `Template/TZ.xlsx`, находит там этот код в колонке B и забирает **текстовое описание** из колонки C.
  - Именно это описание вставляется в ячейку `ExtraField1`.
- **Обработка транслитерации**:
  - Скрипт умеет обрабатывать расхождения в написании кодов, когда в имени файла используется латинская буква, а в `TZ.xlsx` — кириллическая.
  - Пример: код `I.11.1b` из имени файла будет успешно сопоставлен с кодом `I.11.1б` в справочнике.
  - Поддерживаемые замены: `a`→`а`, `b`→`б`, `v`→`в`, `g`→`г`.

---

## Требования к шаблонам
### `CommentSheet_Template.xltx`
| Элемент                  | Требование                                                                     | Пример/Комментарий                      |
|-------------------------|----------------------------------------------------------------------------------|-----------------------------------------|
| Формат                  | `.xltx` (предпочтительно) или `.xlsx`                                           | `CommentSheet_Template.xltx`            |
| Именованные ячейки      | `ReportName` → D1; `CreatedDate` → D4; `ExtraField1` → D6                | В D4 формат даты: `dd.mm.yyyy`          |

### `TZ.xlsx`
| Элемент                  | Требование                                                                     |
|-------------------------|----------------------------------------------------------------------------------|
| Лист с данными          | Должен называться `sheet1`.                                                      |
| Колонка B               | Содержит уникальные коды пунктов (например, `I.7.4`, `II.2.6`).                  |
| Колонка C               | Содержит полное описание работ, соответствующее коду в колонке B.              |

---

## Алгоритм работы скрипта
1.  При запуске скрипта появляется системное окно для выбора папки.
2.  Найти в выбранной папке и **во всех вложенных подпапках** все файлы `*.docx` и `*.pdf`, имена которых начинаются с `CT-DR-`.
3.  Для каждого найденного отчёта сформировать имя выходного файла: `<имя_отчёта>_CMM.xlsx`.
4.  Если итоговый файл уже существует — пропустить его обработку.
5.  Открыть шаблон `CommentSheet_Template.xltx`, создать новую книгу на его основе.
6.  Заполнить ячейки:
    - `ReportName` (D1) = имя отчёта **без** расширения (`.docx` или `.pdf`).
    - `CreatedDate` (D4) = текущая дата (формат `dd.mm.yyyy`).
    - `ExtraField1` (D6):
        - Извлечь код (например, `I.7.4`) из имени входного файла.
        - Найти этот код в колонке B файла `TZ.xlsx`.
        - Вставить в ячейку значение из колонки C найденной строки.
        - Если код не найден в справочнике, вставить в ячейку предупреждение.
7.  Сохранить новую книгу рядом с исходным отчётом.
8.  По завершении вывести в консоль сводку по обработанным файлам.

---

## Реализация: Python

### Установка
```bash
pip install openpyxl
```

### Скрипт `toir_plan_checklist.py`
Ключевые настройки в начале файла:
```python
# === НАСТРОЙКИ ===
TEMPLATE_PATH = Path("Template/CommentSheet_Template.xltx")
DATE_FMT = "dd.mm.yyyy"    # Формат даты
TZ_FILE_PATH = Path("Template/TZ.xlsx")
```

### Запуск
Запустите скрипт (из корня репозитория):
```bash
python toir_plan_checklist.py
```
После этого появится окно, в котором нужно будет указать папку для обработки.

---

## Обработка краевых случаев (как реализовано в скрипте)
- **`_CMM.xlsx` уже существует**: Пропускается, существующий файл не перезаписывается.
- **Код раздела не найден в имени файла**: В `ExtraField1` будет вставлено сообщение об ошибке.
- **Код раздела не найден в `TZ.xlsx`**: В `ExtraField1` будет вставлено предупреждение `ОПИСАНИЕ ДЛЯ ... НЕ НАЙДЕНО`.
- **Отсутствуют именованные диапазоны**: Скрипт использует ячейки по умолчанию (D1, D4, D6) и создает диапазоны для `ReportName` и `CreatedDate`.

---

## Критерии приёмки (чек-лист)
- [ ] Для каждого `CT-DR-*.docx` и `CT-DR-*.pdf` (включая файлы в подпапках) создан `*_CMM.xlsx` в той же папке.
- [ ] В D1 — точное имя отчёта без расширения.
- [ ] В D4 — текущая дата, формат `dd.mm.yyyy`.
- [ ] В D6 — полное описание работы из колонки C файла `TZ.xlsx`, соответствующее коду из имени отчёта.
- [ ] Повторный запуск не перезаписывает готовые файлы.

---

## Структура репозитория
'''
toir_plan_checklist/
├─ README.md
├─ toir_plan_checklist.py
├─ Template/
│  ├─ CommentSheet_Template.xltx
│  └─ TZ.xlsx
├─ test/
│  ├─ CT-DR-B-LP-BVS13-I.7.4-00-1G-20250815-00.docx
│  └─ ...
└─ doc/
'''
