# Скрипт `toir_tra_report.py`

## 1. Назначение

Скрипт предназначен для автоматизации создания отчета "Transmittal" (сопроводительная ведомость) в формате Excel. Он сканирует указанную пользователем папку с документами, извлекает из их имен специальные индексы, находит по этим индексам полные наименования документов и формирует итоговый `.xlsx` файл на основе заданного шаблона.

Утилита имеет графический интерфейс (GUI) для удобства использования.

## 2. Основные возможности

- **Графический интерфейс**: Удобное окно для выбора папки, статуса, шаблона и опций.
- **Выбор статуса отправки**: Позволяет выбрать назначение трансмиттала (`izdato na pregled_GST`, `na uvid_app` и т.д.), что определяет набор доступных шаблонов.
- **Динамическая загрузка шаблонов**: Меню выбора шаблона компании (GST, TER, XXX) заполняется автоматически на основе файлов, найденных в папке выбранного статуса.
- **Автоматическое определение шаблона**: После выбора статуса, скрипт пытается угадать нужный шаблон компании (GST, TER, KBV и др.) по имени выбранной папки с документами.
- **Извлечение данных из имен файлов**: Распознает индексы документов (например, `IV.1.a`) прямо из имен файлов.
- **Поиск наименований**: Автоматически подставляет полное наименование документа в отчет, находя его по индексу в специальном файле `TZ.xlsx`.
- **Динамическое добавление строк**: Автоматически вставляет в Excel-файл необходимое количество строк в зависимости от числа найденных документов, сохраняя форматирование "подвала" таблицы.
- **Архивация**: Может автоматически создавать ZIP-архив со всеми обработанными документами.
- **Очистка**: Может удалять исходные файлы после их успешной архивации.
- **Инкрементальное сохранение**: Сохраняет отчет с уникальным именем, добавляя дату и порядковый номер (например, `CT-GST-TRA-PRM-250903_01.xlsx`).

## 3. Принцип работы

1.  **Запуск**: Пользователь запускает скрипт, и на экране появляется главное окно.
2.  **Выбор папки**: Пользователь нажимает "Выбрать папку..." и указывает на директорию с документами.
3.  **Выбор статуса**: Пользователь выбирает нужный статус отправки из выпадающего меню (например, "izdato na pregled_GST").
4.  **Обновление шаблонов**: Скрипт сканирует соответствующую подпапку с шаблонами (например, `Template/template_tra/izdato_na_pregled_gst/`) и обновляет меню выбора компании.
5.  **Автовыбор шаблона**: Скрипт анализирует имя папки с документами и автоматически выбирает наиболее подходящий шаблон компании (GST, TER, и т.д.), если находит совпадение. В противном случае выбирается "Общий (XXX)".
6.  **Настройка опций**: Пользователь может выбрать, нужно ли создавать ZIP-архив и удалять ли исходные файлы.
7.  **Формирование отчета**: После нажатия кнопки скрипт выполняет основную логику: загружает нужный шаблон, сканирует файлы, вставляет и заполняет строки, сохраняет результат, архивирует и открывает папку.

## 4. Требования

- **Python**: Версия 3.8 или новее.
- **Библиотеки**: Необходимо установить `openpyxl`.
  ```bash
  pip install openpyxl
  ```
- **Структура папок**: Скрипт ожидает строго определенную структуру папок для шаблонов:
  ```
  .
  ├── toir_tra_report.py       # Сам скрипт
  ├── Template/
  │   ├── TZ.xlsx              # Файл с индексами и наименованиями
  │   └── template_tra/
  │       ├── izdato_na_pregled_gst/  # Папка для статуса 1
  │       │   ├── CT-GST-TRA-PRM-Template.xltx
  │       │   └── CT-XXX-TRA-PRM-Template.xltx
  │       ├── na_uvid_app/            # Папка для статуса 2
  │       │   └── ...
  │       └── za_upotrebu_cmm/        # Папка для статуса 3
  │           └── ...
  └── ...
  ```

## 5. Использование

1.  Убедитесь, что выполнены все требования и структура папок корректна.
2.  Запустите скрипт из командной строки:
    ```bash
    python toir_tra_report.py
    ```
3.  В открывшемся окне:
    - **Шаг 1**: Нажмите **"Выбрать папку..."** и укажите путь к вашим документам.
    - **Шаг 2**: Выберите **статус отправки** из второго выпадающего меню.
    - **Шаг 3**: Убедитесь, что в третьем меню **выбран правильный шаблон компании**. При необходимости измените его вручную.
    - **Шаг 4**: Установите галочки **"Создать ZIP-архив"** и **"Удалить исходные файлы"** по необходимости.
    - **Шаг 5**: Нажмите кнопку **"Сформировать отчет"**.
4.  Дождитесь сообщения "Готово!" в статус-баре. Папка с результатом откроется автоматически.

## 6. Важные замечания

- **Структура шаблонов**: Шаблоны для разных статусов теперь должны лежать в разных подпапках (`izdato_na_pregled_gst`, `na_uvid_app` и т.д.), как показано в разделе "Требования".
- **Именование файлов**: Чтобы наименование документа (`Назив документа`) заполнилось автоматически, имя файла **должно содержать индекс** в формате `РИМСКАЯ.ЦИФРА.ЦИФРАбуква`. Например: `MyDoc_IV.1.a_rev2.pdf`.
- **Файл `TZ.xlsx`**: Этот файл является общей "базой знаний" для всех статусов и шаблонов. Он должен содержать сопоставление индексов и наименований.
- **Якорь `FooterAnchor`**: В Excel-шаблонах по-прежнему должен быть именованный диапазон `FooterAnchor` в строке начала "подвала" таблицы для корректной вставки строк.

## 7. План развития (Roadmap)

### Гибкая настройка шаблонов

**Задача:** Дать пользователям (в том числе после компиляции в `.exe`) возможность указывать свою папку с шаблонами и динамически управлять их списком без редактирования исходного кода.

**Предлагаемое решение:**

1.  **Файл настроек пути (`settings.json`):**
    *   Создать файл `settings.json` рядом с исполняемым файлом.
    *   В этом файле будет храниться путь к папке с шаблонами, которую выберет пользователь.
    *   Если файл или путь отсутствует, программа будет использовать папку по умолчанию (`Template/template_tra`).

2.  **Файл конфигурации шаблонов (`templates.json`):**
    *   В папке с шаблонами (пользовательской или по умолчанию) будет лежать файл `templates.json`.
    *   Этот файл будет определять, какие шаблоны доступны в программе. Пользователи смогут редактировать его, чтобы добавлять/удалять свои шаблоны.
    *   **Пример `templates.json`:**
        ```json
        {
          "Общий (XXX)": "CT-XXX-TRA-PRM-Template.xltx",
          "Gastrans (GST)": "CT-GST-TRA-PRM-Template.xltx",
          "Новая Компания (NEW)": "template-for-new-company.xltx"
        }
        ```

3.  **Изменения в интерфейсе:**
    *   Добавить в верхнее меню программы раздел **"Настройки"**.
    *   В этом меню будет пункт **"Указать папку с шаблонами..."**, который позволит пользователю выбрать папку.
    *   После выбора папки программа запомнит путь в `settings.json` и автоматически перезагрузит список шаблонов из нового `templates.json`.

4.  **Логика работы программы:**
    *   **При запуске:** Программа читает `settings.json`, определяет путь к шаблонам, затем читает `templates.json` из этой папки и динамически строит интерфейс.
    *   **Автовыбор:** Логика автоматического выбора шаблона по имени папки (GST, TER) будет так же работать с динамически загруженным списком.

**Результат:**
*   Программа станет полностью настраиваемой для конечного пользователя.
*   Отпадет необходимость в редактировании кода для добавления новых шаблонов.
*   Сохранится простота использования "из коробки" с шаблонами по умолчанию.
