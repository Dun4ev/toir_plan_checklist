# Отчёт по передаче документов: `toir_tra_report.py`

## 1. Назначение
- Формирует ведомость передачи документов (Transmittal) в Excel на основе выбранной папки и шаблонов.
- Подставляет текущую дату, настраивает печатную область, переносит строки и слияния.
- Ищет названия работ по индексам из `TZ.xlsx` (если файл присутствует).
- Сохраняет итоговый Excel с автоинкрементом в имени и, по желанию, собирает ZIP с вложениями.

## 2. Новое и важное
- **Ссылка на папку в статус-баре**: После выбора папки в нижней панели появляется кликабельная ссылка на нее, позволяющая быстро открыть каталог в проводнике.
- Первый запуск: если `toir_tra_report/settings.json` отсутствует, он создаётся автоматически с:
  - `templates_path`: пусто;
  - `company_names`: предзаполненный список компаний (по умолчанию).
- “3. Выберите компанию (шаблон)”: если аббревиатура в имени папки не найдена, автоматически выбирается общий шаблон `(XXX) Общий` (если он есть для выбранного статуса).
- Путь к шаблонам можно задать в меню настроек GUI — он сохраняется в `settings.json` и используется далее.

## 3. Структура шаблонов
- Корень шаблонов: `<TEMPLATES_ROOT>/Template/template_tra`.
- Подпапки статусов (создаются автоматически, если нет):
  - `izdato_na_pregled_gst`
  - `na uvid_app`
  - `za_upotrebu_cmm`
- Имена файлов шаблонов: `CT-<ABBR>-TRA-PRM-Template.xltx`.
- Общий шаблон: `CT-XXX-TRA-PRM-Template.xltx` (рекомендуется иметь в каждой подпапке статуса).
- `TZ.xlsx` ожидается в `<TEMPLATES_ROOT>/Template/TZ.xlsx`.

## 4. Настройки (`settings.json`)
Расположение: `toir_tra_report/settings.json` (рядом со скриптом).
- `templates_path`: путь к корню шаблонов. Если пусто — используется путь рядом со скриптом.
- `company_names`: словарь аббревиатур и человеческих названий компаний. На первом запуске заполняется значениями по умолчанию.
- Существующий файл не перезаписывается: изменения пользователя сохраняются.

## 5. Использование (GUI)
1) Нажмите “Выбрать папку с документами…” и укажите папку с файлами.
2) **Быстрый доступ к папке**: После выбора папки ее имя появляется в статус-баре в виде ссылки. Нажмите на нее, чтобы открыть папку.
3) Выберите статус (из трёх доступных).
4) Выберите компанию (шаблон):
   - Список строится по файлам `*.xltx` в подпапке выбранного статуса.
   - Автовыбор: если имя папки содержит `_<ABBR>` или `-<ABBR>`, выбирается соответствующий шаблон.
   - Если совпадений нет, автоматически выбирается `(XXX) Общий` (если доступен).
5) Опции архивации: можно создать ZIP с вложениями и (опционально) удалить исходные файлы после упаковки.
6) Нажмите “Сформировать ведомость передачи”. Итоговый Excel и ZIP (если выбран) появятся в целевой папке.

## 6. Результат и имена файлов
- Excel: `CT-<ABBR>-TRA-PRM-<YYMMDD>_<NN>.xlsx`.
- ZIP вложений: `<имя_Excel>_att.zip` (если включено).

## 7. Требования
- Python 3.10+
- `openpyxl` (`pip install openpyxl`)
- `pyinstaller` (для сборки `.exe`)

## 8. Советы и диагностика
- Если список шаблонов пуст — проверьте `templates_path` и наличие подпапок статусов.
- Если не подставляется `(XXX) Общий`, убедитесь, что файл `CT-XXX-TRA-PRM-Template.xltx` есть в подпапке выбранного статуса.
- При отсутствии `TZ.xlsx` скрипт работает, но названия работ по индексам могут не подставляться.

## 9. Расположение файлов
- Скрипт: `toir_tra_report/toir_tra_report.py`
- Этот документ: `toir_tra_report/toir_tra_report.md`
- Настройки: `toir_tra_report/settings.json`
- Шаблоны: `<TEMPLATES_ROOT>/Template/template_tra/<status>/CT-<ABBR>-TRA-PRM-Template.xltx`

## 10. Сборка `.exe` файла

Для создания исполняемого `.exe` файла используется PyInstaller.

### Команда для сборки
Выполните эту команду в корневой папке проекта:
```bash
pyinstaller --onefile --windowed --name toir_tra_report --add-data "toir_tra_report/Template;Template" --add-data "toir_tra_report/settings.json;." --add-data "image.png;." toir_tra_report/toir_tra_report.py
```

### Поведение `.exe` (важно)

Скрипт специально адаптирован для корректной работы после сборки в `.exe`:

-   **Первый запуск**: При первом запуске `.exe` файла, он автоматически создаст **рядом с собой**:
    1.  Файл `settings.json` (с настройками по умолчанию).
    2.  Папку `Template` со всей структурой и файлами шаблонов (`.xltx`).
-   **Последующие запуски**: Программа будет использовать именно эти, "внешние" `settings.json` и `Template`, которые находятся рядом с `.exe`.

Это сделано для того, чтобы ваши настройки (например, путь к другой папке с шаблонами) и любые изменения в шаблонах **сохранялись** между запусками программы. Файлы, встроенные внутрь `.exe`, не могут быть изменены после сборки, поэтому программа выносит их наружу.
