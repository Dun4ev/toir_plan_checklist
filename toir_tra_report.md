# Документация к скрипту `toir_tra_report.py`

## 1. Назначение скрипта

Основная задача скрипта — автоматическое создание Excel-отчета (трансмиттала) на основе шаблона `.xltx`. Скрипт сканирует указанную папку, находит в ней файлы документов (PDF, Word, Excel и т.д.), и для каждого найденного файла добавляет строку в таблицу Excel-отчета.

Ключевые возможности:
-   Загружает данные из шаблона Excel (`.xltx`).
-   Автоматически проставляет текущую дату в шапку отчета.
-   Сканирует папку с документами и формирует список файлов для отчета.
-   Для каждого файла извлекает "индекс" из его имени (например, `I.12.7a`).
-   Использует "индекс" для поиска соответствующего ему полного наименования ("назив") в отдельном файле-справочнике (`TZ.xlsx`).
-   Динамически добавляет строки в таблицу, сохраняя при этом целостность и форматирование подвала (футера), даже если в нем есть объединенные ячейки.
-   Сохраняет итоговый отчет в новый `.xlsx` файл с уникальным именем (добавляя дату и порядковый номер).

## 2. Конфигурация

Все основные параметры скрипта задаются в секции `# ============= НАСТРОЙКИ =============`.

-   `TEMPLATE_PATH`: Путь к файлу шаблона трансмиттала (`.xltx`).
-   `OUTPUT_DIR`: Папка, куда будет сохранен готовый `.xlsx` отчет.
-   `DOCS_DIR`: Папка, в которой скрипт ищет файлы для включения в отчет.
-   `TZ_FILE_PATH`: Путь к файлу-справочнику `TZ.xlsx`, который содержит соответствия между индексами и полными наименованиями документов.
-   `DATE_CELL_ADDR`: Адрес ячейки (например, "C3"), куда будет вставлена текущая дата.
-   `FOOTER_ANCHOR_NAME`: Имя именованного диапазона в Excel (например, "FooterAnchor"), который указывает на начало подвала. Это ключевой элемент для сохранения структуры подвала.
-   `FIRST_DATA_ROW`: Номер первой строки, с которой начинается вставка данных о файлах.
-   `COL_*`: Номера колонок для вставки данных ("Ред. Број", "Број документа", "Назив документа").
-   `MERGE_*`: Диапазоны колонок, которые нужно объединять для каждой строки данных.
-   `ALLOWED_EXT`: Расширения файлов, которые скрипт будет считать документами и включать в отчет.
-   `RE_INDEX`: Регулярное выражение для поиска индекса в имени файла.

## 3. Логика работы

### 3.1. Основной процесс (`main`)

1.  **Проверка путей:** Скрипт проверяет наличие шаблона, папки с документами и файла-справочника.
2.  **Загрузка:** Загружается шаблон `.xltx` и активируется рабочий лист.
3.  **Дата:** В указанную ячейку (`DATE_CELL_ADDR`) вставляется текущая дата.
4.  **Поиск подвала:** Определяется номер строки, с которой начинается подвал, с помощью именованного диапазона `FooterAnchor`.
5.  **Сбор данных:**
    -   `list_docs()`: Собирается список файлов из папки `DOCS_DIR`.
    -   `build_tz_map_from_xlsx()`: Загружается справочник `TZ.xlsx` и создается словарь вида `{"индекс": "наименование"}`.
6.  **"Безопасная" вставка строк:**
    -   Вычисляется, сколько строк уже есть для данных в шаблоне и сколько всего файлов нужно добавить.
    -   Если места не хватает, вызывается функция `insert_rows_and_preserve_footer_merges`.
7.  **Заполнение данных:** Вызывается функция `fill_rows`, которая проходит по списку файлов и заполняет таблицу.
8.  **Обновление якоря:** Именованный диапазон `FooterAnchor` сдвигается на новую позицию.
9.  **Сохранение:** Готовый отчет сохраняется как `.xlsx` файл с помощью `save_with_increment`. Флаг `wb.template = False` используется, чтобы сохранить обычную книгу, а не шаблон.

### 3.2. Сохранение структуры подвала

Это самая важная и нетривиальная часть логики, реализованная в функции `insert_rows_and_preserve_footer_merges`.

Проблема заключается в том, что при программной вставке строк (`ws.insert_rows()`) `openpyxl` сдвигает ячейки вниз, но "забывает" сдвинуть объединенные диапазоны ячеек, что ломает форматирование.

Алгоритм решения:
1.  **Найти и запомнить:** Перед вставкой строк скрипт находит все объединенные диапазоны ячеек, которые находятся на уровне подвала или ниже.
2.  **Разъединить:** Все эти диапазоны временно разъединяются.
3.  **Вставить строки:** Вставляется необходимое количество пустых строк.
4.  **Сдвинуть и восстановить:** Координаты каждого запомненного диапазона программно сдвигаются вниз на нужное количество строк, после чего объединенные ячейки восстанавливаются на их новых позициях.

Этот подход гарантирует, что сложная структура подвала со всеми объединенными ячейками останется нетронутой и просто переместится ниже.

### 3.3. Заполнение строк (`fill_rows`)

Эта функция отвечает непосредственно за внесение информации в ячейки:
-   Проставляет порядковый номер.
-   Вставляет имя файла и делает его гиперссылкой, ведущей к самому файлу.
-   Извлекает из имени файла индекс (`extract_index_from_name`), ищет по нему наименование в загруженном справочнике и вставляет его. Если наименование не найдено, вставляется имя файла без расширения.
-   Для каждой строки применяет необходимое объединение ячеек (`ensure_row_merges`).