# Документация к скрипту `toir_tra_report.py`

## 1. Назначение скрипта

Основная задача скрипта — автоматическое создание Excel-отчета (трансмиттала) на основе шаблона `.xltx`. Скрипт рекурсивно сканирует указанную папку и все ее подпапки, находит в них файлы документов (PDF, Word, Excel и т.д.), и для каждого найденного файла добавляет строку в таблицу Excel-отчета.

Ключевые возможности:
-   Загружает данные из шаблона Excel (`.xltx`).
-   Автоматически проставляет текущую дату в шапку отчета.
-   Сканирует папку с документами и формирует список файлов для отчета.
-   Для каждого файла извлекает "индекс" из его имени (например, `II.12` или `I.12.7a`).
-   Использует "индекс" для поиска соответствующего ему полного наименования ("назив") в отдельном файле-справочнике (`TZ.xlsx`), автоматически распознавая варианты написания (латиница/кириллица).
-   Добавляет специальные префиксы к наименованию: `"Корективно одржавање. "` (если имя файла содержит `-C-`) и `"Листа коментара уз документ. "` (если имя файла содержит `_CMM`).
-   Динамически добавляет строки в таблицу, копируя форматирование (шрифты, границы, высота, значения постоянных ячеек) из строки-образца.
-   Устанавливает автоматический перенос текста для длинных наименований.
-   Полностью сохраняет и переносит сложный многострочный подвал (футер), сохраняя все его стили, значения и объединенные ячейки.
-   Автоматически расширяет область печати документа, чтобы включить все добавленные строки и подвал.
-   Сохраняет итоговый отчет в новый `.xlsx` файл с уникальным именем (в формате `ПРЕФИКС-ГГММДД_НН.xlsx`).

## 2. Конфигурация

Все основные параметры скрипта задаются в секции `# ============= НАСТРОЙКИ =============`.

-   `TEMPLATE_PATH`: Путь к файлу шаблона трансмиттала (`.xltx`).
-   `OUTPUT_DIR`: Папка, куда будет сохранен готовый `.xlsx` отчет.
-   `DOCS_DIR`: Папка, в которой скрипт рекурсивно (включая все подпапки) ищет файлы для включения в отчет.
-   `TZ_FILE_PATH`: Путь к файлу-справочнику `TZ.xlsx`, который содержит соответствия между индексами и полными наименованиями документов.
-   `DATE_CELL_ADDR`: Адрес ячейки (например, "C3"), куда будет вставлена текущая дата.
-   `FOOTER_ANCHOR_NAME`: Имя именованного диапазона в Excel (например, "FooterAnchor"), который указывает на начало подвала. Это ключевой элемент для сохранения структуры подвала.
-   `FIRST_DATA_ROW`: Номер первой строки, с которой начинается вставка данных о файлах.
-   `COL_*`: Номера колонок для вставки данных ("Ред. Број", "Број документа", "Назив документа").
-   `MERGE_*`: Диапазоны колонок, которые нужно объединять для каждой строки данных.
-   `ALLOWED_EXT`: Расширения файлов, которые скрипт будет считать документами и включать в отчет.
-   `RE_INDEX`: Регулярное выражение для поиска индекса в имени файла.

## 3. Логика работы

## 3. Логика работы

### 3.1. Основной процесс (`main`)

1.  **Проверка путей и загрузка:** Скрипт проверяет наличие всех необходимых файлов и загружает шаблон `.xltx`.
2.  **Дата:** В указанную ячейку (`C3`) вставляется текущая дата.
3.  **Поиск подвала:** Определяется номер строки, с которой начинается подвал, с помощью именованного диапазона `FooterAnchor`.
4.  **Сбор данных:** Собирается список файлов из папки `DOCS_DIR` и загружается справочник `TZ.xlsx`.
5.  **"Безопасная" вставка строк:** Если для новых данных не хватает места, вызывается функция `insert_rows_and_preserve_footer_merges` для добавления нужного количества строк.
6.  **Заполнение данных:** Вызывается функция `fill_rows`, которая проходит по списку файлов и заполняет таблицу, применяя все правила форматирования (подробнее см. п. 3.3).
7.  **Обновление якоря:** Именованный диапазон `FooterAnchor` сдвигается на новую позицию под вставленными строками.
8.  **Настройка области печати:** Устанавливается область печати от `B3` до последней строки подвала (`P<номер_последней_строки>`).
9.  **Сохранение:** Готовый отчет сохраняется как новый `.xlsx` файл с уникальным именем.

### 3.2. Сохранение структуры подвала

Это одна из ключевых возможностей скрипта, реализованная в функции `insert_rows_and_preserve_footer_merges`. Так как просто вставить строки в Excel недостаточно (теряется форматирование), скрипт выполняет полноценное "перемещение" всего блока подвала.

Алгоритм "перемещения":
1.  **"Фотографирование" подвала:** Перед любыми изменениями скрипт делает полный "снимок" всего, что находится ниже таблицы с данными. В память копируются:
    -   Значения и стили (шрифт, цвет, границы) каждой ячейки.
    -   Высота каждой строки подвала.
    -   Все объединенные ячейки.
2.  **Вставка пустых строк:** Скрипт вставляет необходимое количество пустых строк над тем местом, где раньше начинался подвал.
3.  **Воссоздание подвала:** На новом месте (ниже вставленных пустых строк) скрипт по "снимку" из памяти воссоздает точную копию подвала со всем исходным форматированием.

Этот подход гарантирует, что сложная структура подвала со всеми стилями останется нетронутой и просто переместится ниже.

### 3.3. Заполнение строк (`fill_rows`)

Эта функция отвечает за комплексное формирование каждой строки с данными.

**Порядок операций для каждой строки:**
1.  **Копирование стиля и констант:**
    -   Копируется полное форматирование (стили ячеек из диапазона `B:P` и высота строки) из первой строки данных (строка 18), которая служит образцом.
    -   Копируются постоянные значения из ячеек `M18`, `N18`, `O18` в соответствующие ячейки новой строки.
2.  **Объединение ячеек:** Применяется необходимое объединение для колонок "Број документа" и "Назив документа".
3.  **Заполнение динамических данных:**
    -   Проставляется порядковый номер.
    -   -   Вставляет имя файла.
    -   Устанавливается **перенос текста** для ячеек "Број документа" и "Назив документа".
    -   Формируется "Назив документа":
        -   Из имени файла извлекается индекс (например, `I.12.7a`).
        -   По индексу в справочнике `TZ.xlsx` находится базовое наименование. Если соответствие не найдено, ячейка остается пустой, что служит индикатором для проверки.
            -   **Примечание:** Поиск устойчив к раскладке. Скрипт автоматически приводит суффиксы индексов к единому формату (кириллице), поэтому `I.12.2b` из имени файла успешно найдет `I.12.2Б` в справочнике.
        -   К наименованию добавляются префиксы в зависимости от содержимого имени файла:
            -   `"Корективно одржавање. "`, если в имени есть `"-C-"`.
            -   `"Листа коментара уз документ. "`, если в имени есть `"_CMM"`.
        -   Итоговое наименование вставляется в ячейку.

## План развития (Roadmap)

### Гибкая настройка шаблонов

**Задача:** Дать пользователям (в том числе после компиляции в `.exe`) возможность указывать свою папку с шаблонами и динамически управлять их списком без редактирования исходного кода.

**Предлагаемое решение:**

1.  **Файл настроек пути (`settings.json`):**
    *   Создать файл `settings.json` рядом с исполняемым файлом.
    *   В этом файле будет храниться путь к папке с шаблонами, которую выберет пользователь.
    *   Если файл или путь отсутствует, программа будет использовать папку по умолчанию (`Template/template_tra`).

2.  **Файл конфигурации шаблонов (`templates.json`):**
    *   В папке с шаблонами (пользовательской или по умолчанию) будет лежать файл `templates.json`.
    *   Этот файл будет определять, какие шаблоны доступны в программе. Пользователи смогут редактировать его, чтобы добавлять/удалять свои шаблоны.
    *   **Пример `templates.json`:**
        ```json
        {
          "Общий (XXX)": "CT-XXX-TRA-PRM-Template.xltx",
          "Gastrans (GST)": "CT-GST-TRA-PRM-Template.xltx",
          "Новая Компания (NEW)": "template-for-new-company.xltx"
        }
        ```

3.  **Изменения в интерфейсе:**
    *   Добавить в верхнее меню программы раздел **"Настройки"**.
    *   В этом меню будет пункт **"Указать папку с шаблонами..."**, который позволит пользователю выбрать папку.
    *   После выбора папки программа запомнит путь в `settings.json` и автоматически перезагрузит список шаблонов из нового `templates.json`.

4.  **Логика работы программы:**
    *   **При запуске:** Программа читает `settings.json`, определяет путь к шаблонам, затем читает `templates.json` из этой папки и динамически строит интерфейс.
    *   **Автовыбор:** Логика автоматического выбора шаблона по имени папки (GST, TER) будет так же работать с динамически загруженным списком.

**Результат:**
*   Программа станет полностью настраиваемой для конечного пользователя.
*   Отпадет необходимость в редактировании кода для добавления новых шаблонов.
*   Сохранится простота использования "из коробки" с шаблонами по умолчанию.
